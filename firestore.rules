rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function canReadGame(gameId) {
      let game = get(/databases/$(database)/documents/games/$(gameId));
      return game.data != null
        && (
          (game.data.state != null && game.data.state.status == "waiting")
          || (game.data.players != null && request.auth.uid in game.data.players)
        );
    }

    // User profiles:
    // - Any authenticated user can read any profile (e.g., to show display names/avatars).
    // - Only the owner can create or update their own profile document.
    // - Deletes are not allowed via client.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }

    // Games:
    // - Any authenticated user can read games in "waiting" state.
    // - For other states, only players in the game's players array can read.
    match /games/{gameId} {
      allow read: if request.auth != null
        && (
          (resource.data.state != null && resource.data.state.status == "waiting")
          || (resource.data.players != null && request.auth.uid in resource.data.players)
        );
    }

    // Game Players subcollection:
    // - Any authenticated user can read when parent game is "waiting".
    // - For other states, only players in the parent game's players array can read.
    match /games/{gameId}/players/{playerId} {
      allow read: if request.auth != null && canReadGame(gameId);
    }

    // Player private hand data:
    // - Only the owner (playerId) can read their own hand.
    // - Cloud Functions write on behalf of players with proper auth.
    match /games/{gameId}/playerHands/{playerId} {
      allow read: if request.auth != null && request.auth.uid == playerId;
    }

    // Deny everything else by default.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

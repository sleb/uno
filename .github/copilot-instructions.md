# Copilot Instructions

- **Monorepo**: Bun workspaces at root; packages are `@uno/web` (frontend), `@uno/functions` (Firebase Cloud Functions), and `@uno/shared` (schemas/types).
- **Install**: Run `bun install` at root to hoist deps; per-package readmes exist in packages/* for quick run commands.
- **Build/Run web**: From packages/web, `bun dev` for hot reload, `bun build ./src/index.html --outdir=dist --sourcemap --target=browser --env='UNO_PUBLIC_*'`, `bun start` for prod server (uses Bun `serve` in [packages/web/src/index.ts](packages/web/src/index.ts)). Entry renders React tree in [packages/web/src/frontend.tsx](packages/web/src/frontend.tsx) and routes in [packages/web/src/router.tsx](packages/web/src/router.tsx).
- **Build functions**: From packages/functions, `bun build src/index.ts --outdir dist --target node --format cjs --external firebase-admin --external firebase-functions`; target Node 22; main exported in [packages/functions/src/index.ts](packages/functions/src/index.ts).
- **Environment**: Web expects env vars prefixed `UNO_PUBLIC_` (API key, project ID, etc.) in [packages/web/src/firebase.ts](packages/web/src/firebase.ts). When `NODE_ENV !== "production"`, auth/firestore/functions auto-connect to emulators (9099/8080/5001), so set those up for local.
- **Shared schemas**: Zod models for users/games/cards and createGame request/response live in [packages/shared/src/types.ts](packages/shared/src/types.ts); re-exported via [packages/shared/src/index.ts](packages/shared/src/index.ts). Always validate Firestore/Function payloads with these (see converters below).
- **Frontend data layer**: Firebase initialized in [packages/web/src/firebase.ts](packages/web/src/firebase.ts); Firestore converters pattern shown in [packages/web/src/service/profile-service.ts](packages/web/src/service/profile-service.ts) and [packages/web/src/service/game-service.ts](packages/web/src/service/game-service.ts). Validate snapshots with `GameSchema.parse`/`UserSchema.parse` before use. `httpsCallable` is used for the `createGame` function; response parsed with `CreateGameResponseSchema`.
- **Auth/profile gating**: `AuthRequired` wraps routes to enforce Firebase auth, providing UID via [packages/web/src/context/auth.ts](packages/web/src/context/auth.ts) and hook [packages/web/src/hooks/uid.ts](packages/web/src/hooks/uid.ts). `ProfileRequired` subscribes to user doc and either provides `ProfileContext` + `useUser` or renders the profile creation flow ([packages/web/src/context/profile.ts](packages/web/src/context/profile.ts), [packages/web/src/hooks/user.ts](packages/web/src/hooks/user.ts)). Layout shell in [packages/web/src/components/layout.tsx](packages/web/src/components/layout.tsx).
- **UI stack**: React 19, React Router v7, Mantine 8 for components/theming ([packages/web/src/theme.tsx](packages/web/src/theme.tsx)), TanStack Query for data caching. Hot module handling uses Bun HMR in frontend entry.
- **Functions logic**: Cloud Function `createGame` declared in [packages/functions/src/create-game-function.ts](packages/functions/src/create-game-function.ts); delegates to Firestore service [packages/functions/src/service/game-service.ts](packages/functions/src/service/game-service.ts) using a converter and `games` collection. Returns `{ gameId }`; errors wrapped as `HttpsError` with logging.
- **Firestore transactions**: Use `db.runTransaction()` for multi-document writes that must succeed/fail atomically (e.g., game creation with host player). Prevents orphaned documents and race conditions. Example: `createGame` creates game + player doc in one transaction.
- **Firestore design**: High-level schemas and gameplay expectations documented in [DESIGN.md](DESIGN.md) (users/games/players/cards collections, Uno rules). Align new data fields and rules with that document.
- **Conventions**: Prefer shared Zod schemas for validation and TypeScript types; use Firestore converters for typed reads/writes; keep UNO_PUBLIC env prefix for client-exposed config; keep Bun runtime for scripts/tests; avoid non-ASCII unless required.
- **Testing/validation**: No test harness present yet; lean on schema parsing to catch shape issues. Use Firebase emulators for auth/firestore/functions when iterating locally.
